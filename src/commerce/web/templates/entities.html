{% extends "base.html" %}
{% block content %}
  <h1 class="page-title">엔티티</h1>
  <p class="sub-title">캠페인/그룹/키워드 같은 광고 계층 구조를 확인합니다.</p>

  <section class="card">
    <form method="get" action="/entities" class="row">
      <div class="inline" style="gap:12px; align-items:center">
        <label>플랫폼</label>
        <input name="platform" placeholder="naver / meta / google" value="{{ platform or '' }}" style="width:180px" />
      </div>
      <div class="inline" style="gap:12px; align-items:center">
        <label>타입</label>
        <input name="entity_type" placeholder="campaign / adgroup / keyword" value="{{ entity_type or '' }}" style="width:220px" />
      </div>
      <button type="submit">조회</button>
    </form>
  </section>

  <section class="card">
    {% if entities|length == 0 %}
      <p class="muted">데이터가 없습니다. 임포트 또는 API 동기화를 먼저 수행하세요.</p>
    {% else %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>플랫폼</th>
              <th>타입</th>
              <th>ID</th>
              <th>이름</th>
              <th>상위</th>
              <th>메타</th>
              <th>KPI 연결</th>
            </tr>
          </thead>
          <tbody>
            {% for e in entities %}
              <tr>
                <td>{{ e.platform }}</td>
                <td class="muted">{{ e.entity_type }}</td>
                <td class="muted"><code>{{ e.entity_id }}</code></td>
                <td>{{ e.name or "" }}</td>
                <td class="muted">{{ e.parent_type or "" }} {{ e.parent_id or "" }}</td>
                <td class="muted"><code>{{ e.meta_json }}</code></td>
                <td>
                  <form method="post" action="/entities/attach-kpi" class="inline">
                    <input type="hidden" name="platform" value="{{ e.platform }}" />
                    <input type="hidden" name="entity_type" value="{{ e.entity_type }}" />
                    <input type="hidden" name="entity_id" value="{{ e.entity_id }}" />
                    <select name="kpi_profile_id">
                      {% for p in profiles %}
                        <option value="{{ p.id }}">{{ p.name }} ({{ p.objective }})</option>
                      {% endfor %}
                    </select>
                    <button type="submit">연결</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </section>
{% endblock %}
