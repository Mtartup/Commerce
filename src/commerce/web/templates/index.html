{% extends "base.html" %}
{% block content %}
  <h1 class="page-title">Commerce 대시보드</h1>

  <div class="totals-banner">
    <div class="total-item">
      <div class="label">{{ "오늘" if is_today else "기준일" }} 전체 주문</div>
      <div class="value">{{ total_orders }}건</div>
      <div class="sub">전 채널 합산</div>
    </div>
    <div class="total-item">
      <div class="label">{{ "오늘" if is_today else "기준일" }} 전체 매출</div>
      <div class="value">{{ "{:,.0f}".format(total_revenue) }}원</div>
      <div class="sub">전 채널 합산</div>
    </div>
    <div class="total-item">
      <div class="label">광고비</div>
      <div class="value">{{ "{:,.0f}".format(total_spend) }}원</div>
      <div class="sub">광고 플랫폼 합산</div>
    </div>
    <div class="total-item">
      <div class="label">광고 클릭</div>
      <div class="value">{{ "{:,}".format(total_ad_clicks) }}</div>
    </div>
  </div>

  <section class="card">
    <div class="section-header">
      <h2>판매 채널</h2>
      <span class="muted">최근 7일 주문 추이</span>
    </div>
    <div class="channel-grid">
      {% for ch in channel_cards %}
        <a class="channel-item card-link" href="/store?store={{ ch.store }}" aria-label="{{ ch.label }} 상세로 이동">
          <div class="channel-head">
            <div class="channel-title">{{ ch.label }}</div>
            <span class="chip">{{ ch.order_count }}건</span>
          </div>

          {% if ch.has_funnel %}
            <div class="funnel-grid">
              <div>
                <div class="muted funnel-label">방문자</div>
                <div class="funnel-value">{{ "{:,}".format(ch.visitors) }}</div>
              </div>
              <div>
                <div class="muted funnel-label">PV</div>
                <div class="funnel-value">{{ "{:,}".format(ch.pv) }}</div>
                <div class="muted tiny">{{ "%.1f"|format(ch.pv_per_visit) }}/방문</div>
              </div>
              <div>
                <div class="muted funnel-label">주문</div>
                <div class="funnel-value">{{ ch.order_count }}건</div>
                <div class="muted tiny">전환 {{ "%.2f"|format(ch.cvr) }}%</div>
              </div>
            </div>
          {% else %}
            <div class="metric-rows compact">
              <div><span class="muted">주문</span>{{ ch.order_count }}건</div>
            </div>
            <div class="muted tiny">방문자 데이터 없음</div>
          {% endif %}

          <div class="metric-rows compact">
            <div><span class="muted">매출</span>{{ "{:,.0f}".format(ch.total_amount) }}원</div>
          </div>
          <div class="muted tiny">매출 바 (채널 최대 매출=100%)</div>
          <div class="viz-track">
            <span class="viz-fill" style="width: {{ '%.2f'|format(ch.revenue_ratio) }}%"></span>
          </div>

          <div class="sparkline" aria-hidden="true">
            {% for h in ch.orders_series_norm %}
              <span class="spark-bar" style="height: {{ '%.2f'|format(h) }}%"></span>
            {% endfor %}
          </div>
        </a>
      {% endfor %}
    </div>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>광고 플랫폼</h2>
      <a href="/metrics?platform=naver&entity_type=campaign">상세 &rarr;</a>
    </div>
    <div class="summary-grid platform-grid">
      {% for c in platform_cards %}
        <a class="metric metric-link" href="/metrics?platform={{ c.platform }}&entity_type=campaign" aria-label="{{ c.label }} 광고 성과로 이동">
          <div class="metric-head">
            <div>
              <div class="label">{{ c.label }}</div>
            </div>
            <span class="chip tone-{{ c.tone }}">{{ c.health }}</span>
          </div>
          <div class="metric-rows compact">
            <div><span class="muted">지출</span>{{ "{:,.0f}".format(c.spend) }}</div>
            <div><span class="muted">클릭</span>{{ "{:,.0f}".format(c.clicks) }}</div>
            <div><span class="muted">전환</span>{{ "{:,.0f}".format(c.conversions) }}</div>
            <div><span class="muted">ROAS</span>{{ "%.2f"|format(c.roas) if c.roas is not none else "-" }}</div>
          </div>
          <div class="viz-track">
            <span class="viz-fill" style="width: {{ '%.2f'|format(c.spend_ratio) }}%"></span>
          </div>
          <div class="sparkline" aria-hidden="true">
            {% for h in c.spend_series_norm %}
              <span class="spark-bar" style="height: {{ '%.2f'|format(h) }}%"></span>
            {% endfor %}
          </div>
        </a>
      {% endfor %}
    </div>
  </section>

  <div class="two-col-grid">
    <section class="card">
      <div class="section-header">
        <h2>미처리 제안</h2>
        <a href="/actions">전체 보기 &rarr;</a>
      </div>
      {% if pending|length == 0 %}
        <p class="muted">승인 대기 중인 제안이 없습니다.</p>
      {% else %}
        <div class="stack-list">
          {% for p in pending[:5] %}
            <div class="list-row">
              <span class="muted">{{ p.platform }} / {{ p.action_type }}</span>
              <code>{{ p.entity_type }}</code>
            </div>
          {% endfor %}
        </div>
        {% if pending|length > 5 %}
          <p class="muted tiny">외 {{ pending|length - 5 }}건</p>
        {% endif %}
      {% endif %}
    </section>

    <section class="card">
      <div class="section-header">
        <h2>연동 상태</h2>
        <a href="/connectors">설정 &rarr;</a>
      </div>
      <div class="health-grid">
        {% for h in connector_health %}
          <div class="health-item">
            <span class="health-dot {{ h.status }}"></span>
            <span>{{ h.label }}</span>
          </div>
        {% endfor %}
      </div>
    </section>
  </div>
{% endblock %}
