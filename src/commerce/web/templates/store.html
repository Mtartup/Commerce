{% extends "base.html" %}
{% block content %}
  <p class="breadcrumb"><a href="/">&larr; 홈</a></p>
  <h1 class="page-title">주문 상세</h1>

  <section class="card">
    <div class="inline filter-inline">
      {% for s, label in [("cafe24","카페24"), ("coupang","쿠팡"), ("smartstore","스마트스토어")] %}
        <a class="chip {% if store == s %}tone-good{% endif %}" href="/store?store={{ s }}&days={{ days }}">{{ label }}</a>
      {% endfor %}
      {% for d in [1, 7, 14, 30] %}
        <a class="chip {% if days == d %}tone-good{% endif %}" href="/store?store={{ store }}&days={{ d }}">{{ d }}일</a>
      {% endfor %}
    </div>
    <p class="muted">현재 로컬 전용입니다. 외부 주문은 직접 주문/클릭 이벤트를 가져와서 반영합니다.</p>
    <p class="note">
      임포트 예시:
      <code>uv run commerce import cafe24-orders --file .\\imports\\cafe24_orders.csv</code>
    </p>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>요약</h2>
      <span class="muted">{{ start }} ~ {{ end }}</span>
    </div>
    <div class="summary-grid">
      <article class="metric">
        <div class="label">총 주문</div>
        <div class="value">{{ total_orders }}</div>
      </article>
      <article class="metric">
        <div class="label">총 매출</div>
        <div class="value">{{ "{:,.0f}".format(total_revenue) }}</div>
      </article>
      <article class="metric">
        <div class="label">평균 주문금액</div>
        <div class="value">{{ "{:,.0f}".format(avg_order_value) if avg_order_value is not none else "-" }}</div>
      </article>
    </div>
    <div class="trend-panel top-gap">
      <h3 class="panel-title">일별 주문 추이</h3>
      <div class="sparkline large" aria-hidden="true">
        {% for t in trend_rows %}
          <span class="spark-bar" style="height: {{ '%.2f'|format(t.orders_norm) }}%"></span>
        {% endfor %}
      </div>
      <div class="trend-footer muted">{{ start }} ~ {{ end }}</div>
    </div>
  </section>

  <section class="card">
    <h2 class="sub-title">{{ start }} ~ {{ end }} 유입 경로 집계</h2>
    {% if summary|length == 0 %}
      <p class="muted">주문 요약이 없습니다.</p>
    {% else %}
      <div class="viz-list">
        {% for s in summary[:12] %}
          <div class="viz-row">
            <div class="viz-label">{{ s.inflow_path }}</div>
            <div class="viz-track"><span class="viz-fill" style="width: {{ '%.2f'|format(s.ratio_norm) }}%"></span></div>
            <div class="viz-value">{{ s.orders }}건 ({{ "%.1f"|format(s.ratio) }}%)</div>
          </div>
        {% endfor %}
      </div>
      {% if summary|length > 12 %}
        <p class="muted tiny">외 {{ summary|length - 12 }}개 경로</p>
      {% endif %}
    {% endif %}
  </section>

  <section class="card">
    <h2 class="sub-title">최근 주문 (최대 200)</h2>
    {% if orders|length == 0 %}
      <p class="muted">주문 데이터가 없습니다.</p>
    {% else %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>날짜</th>
              <th>주문번호</th>
              <th>상태</th>
              <th>유입경로</th>
              <th>상세</th>
              <th>금액</th>
              <th>주문처</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
              <tr>
                <td class="muted"><code>{{ o.date_kst }}</code></td>
                <td><code>{{ o.order_id }}</code></td>
                <td class="muted">{{ o.status or "" }}</td>
                <td class="muted">{{ o.inflow_path or "" }}</td>
                <td class="muted ellipsis-cell">
                  {{ o.inflow_path_detail or o.source_raw or o.referer or "" }}
                </td>
                <td class="muted">
                  {% if o.amount is not none %}
                    {{ o.amount }} {{ o.currency or "" }}
                  {% endif %}
                </td>
                <td class="muted">{{ o.order_place_id or "" }} {{ o.order_place_name or "" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </section>
{% endblock %}
